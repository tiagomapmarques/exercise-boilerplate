#!/usr/bin/env node
import { readFileSync } from 'node:fs';

import { execAsync } from './common/exec.mjs';
import {
  error,
  hasLoggedError,
  hasLoggedInfoWarnOrError,
  hasLoggedWarnOrError,
  info,
  log,
  redBg,
  warn,
} from './common/logs.mjs';
import { highlightSemver, parseSemver } from './common/semver.mjs';

const packageJsonFile = `${import.meta.dirname}/../package.json`;
const dockerFile = `${import.meta.dirname}/../Dockerfile`;
const dockerFileCi = `${import.meta.dirname}/../Dockerfile.ci`;
const nvmrcFile = `${import.meta.dirname}/../.nvmrc`;

const errorOnWarnings = process.argv[2] === '--error-on-warnings';

const getInternetVersions = async () => {
  const fetchPnpm = async () => {
    const output = await execAsync('pnpm self-update 9001');

    const latestLine =
      output
        .split('\n')
        .filter((line) => line.includes('latest-'))
        .pop() || '';

    const latest = latestLine.split(': ').pop() || '';

    return { latest, lts: latest };
  };

  const fetchNode = async () => {
    const response = await fetch(
      'https://nodejs.org/download/release/index.json',
    );
    const data = await response.json();
    return {
      latest: data.find((item) => !item.lts)?.version.slice(1),
      lts: data.find((item) => item.lts)?.version.slice(1),
    };
  };

  const [node, pnpm] = await Promise.all([fetchNode(), fetchPnpm()]);

  return { node, pnpm };
};

const getLocalVersions = () => {
  const { engines, devDependencies } = JSON.parse(
    readFileSync(packageJsonFile).toString(),
  );

  const [latestNode, ltsNode] = engines.node
    .replaceAll('^', '')
    .split('||')
    .map((version) => version.trim());

  const [latestPnpm, ltsPnpm] = engines.pnpm
    .replaceAll('^', '')
    .split('||')
    .map((version) => version.trim());

  const latestPlaywright = devDependencies.playwright.replaceAll(/(~|\^)/g, '');

  return {
    node: { latest: latestNode, lts: ltsNode },
    pnpm: { latest: latestPnpm, lts: ltsPnpm },
    playwright: { latest: latestPlaywright },
  };
};

const getDockerVersions = (file) => {
  const dockerContent = readFileSync(file).toString();

  const [nodeMatch = ''] =
    /ARG NODE_VERSION=\d+.\d+.\d+/.exec(dockerContent) || [];
  const nodeVersion = nodeMatch.slice('ARG NODE_VERSION='.length);

  const [pnpmMatch = ''] =
    /ARG PNPM_VERSION=\d+.\d+.\d+/.exec(dockerContent) || [];
  const pnpmVersion = pnpmMatch.slice('ARG PNPM_VERSION='.length);

  const [playwrightMatch = ''] =
    /ARG PLAYWRIGHT_VERSION=\d+.\d+.\d+/.exec(dockerContent) || [];
  const playwrightVersion = playwrightMatch.slice(
    'ARG PLAYWRIGHT_VERSION='.length,
  );

  return {
    node: { latest: nodeVersion },
    pnpm: { latest: pnpmVersion },
    ...(playwrightVersion && {
      playwright: { latest: playwrightVersion },
    }),
  };
};

const internet = await getInternetVersions();
const local = getLocalVersions();
const docker = getDockerVersions(dockerFile);
const dockerCi = getDockerVersions(dockerFileCi);
const nvmrc = {
  node: {
    latest: readFileSync(nvmrcFile).toString().trim().slice(1),
  },
};

const compare = (name, current, latest, forceError) => {
  if (!current) {
    return;
  }

  const isImportant = name.includes(' ');
  const warnOrError = forceError || errorOnWarnings ? error : warn;
  const logger = isImportant ? warnOrError : info;

  const currentNumber = parseSemver(current);
  const latestNumber = parseSemver(latest);

  if (latestNumber.number > currentNumber.number) {
    const highlight = highlightSemver(latestNumber, currentNumber);
    logger(`New ${name} version available: ${highlight} (current: ${current})`);
  } else if (latestNumber.number < currentNumber.number) {
    error(`\nCurrent version of ${name} (${redBg(current)}) is not valid.\n`);
  }
};

const localNode = local.node.lts || local.node.latest;
const localPnpm = local.pnpm.lts || local.pnpm.latest;
const localPlaywright = local.playwright.lts || local.playwright.latest;

// Compare non-LTS versions
compare('node', local.node.latest, internet.node.latest);
compare('pnpm', local.pnpm.latest, internet.pnpm.latest);

// Compare LTS versions
compare('node LTS', local.node.lts, internet.node.lts);
compare('pnpm LTS', local.pnpm.lts, internet.pnpm.lts);

// Check if project versions are in sync
if (!hasLoggedWarnOrError()) {
  // Dockerfile
  compare('node (Dockerfile)', docker.node.latest, localNode, true);
  compare('pnpm (Dockerfile)', docker.pnpm.latest, localPnpm, true);

  // Dockerfile.ci
  compare('node (Dockerfile.ci)', dockerCi.node.latest, localNode, true);
  compare('pnpm (Dockerfile.ci)', dockerCi.pnpm.latest, localPnpm, true);
  compare(
    'playwright (Dockerfile.ci)',
    dockerCi.playwright.latest,
    localPlaywright,
    true,
  );

  // Nvm
  compare('node (.nvmrc)', nvmrc.node.latest, localNode, true);

  if (!hasLoggedInfoWarnOrError()) {
    log('No engine updates found');
  }
}

if (hasLoggedError()) {
  process.exit(1);
}
